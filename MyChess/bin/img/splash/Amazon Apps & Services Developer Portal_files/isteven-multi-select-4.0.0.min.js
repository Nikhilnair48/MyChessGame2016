/*
 Project started on: Tue, 14 Jan 2014 - 5:18:02 PM
 Current version: 4.0.0

 Released under the MIT License
 --------------------------------------------------------------------------------
 The MIT License (MIT)

 Copyright (c) 2014 Ignatius Steven (https://github.com/isteven)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in all
 copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
 --------------------------------------------------------------------------------
*/
angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function(l,v,B){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"isteven-multi-select.htm",link:function(a,k,c){a.backUp=[];a.varButtonLabel="";a.spacingProperty="";a.indexProperty="";a.orientationH=!1;a.orientationV=!0;
a.filteredModel=[];a.inputLabel={labelFilter:""};a.tabIndex=0;a.lang={};a.helperStatus={all:!0,none:!0,reset:!0,filter:!0};var q=0,u=[],r=0,n="",g=[],x=0,t=null;a.clearClicked=function(b){a.inputLabel.labelFilter="";a.updateFilter();a.select("clear",b)};a.numberToArray=function(a){return Array(a)};a.searchChanged=function(){if(a.inputLabel.labelFilter.length<x&&0<a.inputLabel.labelFilter.length)return!1;a.updateFilter()};a.updateFilter=function(){a.filteredModel=[];var b=0;if("undefined"===typeof a.inputModel)return!1;
for(b=a.inputModel.length-1;0<=b;b--){"undefined"!==typeof a.inputModel[b][c.groupProperty]&&!1===a.inputModel[b][c.groupProperty]&&a.filteredModel.push(a.inputModel[b]);var f=!1;if("undefined"===typeof a.inputModel[b][c.groupProperty]){if("undefined"!==typeof c.searchProperty&&""!==c.searchProperty)for(var e in a.inputModel[b]){if("boolean"!==typeof a.inputModel[b][e]&&0<=String(a.inputModel[b][e]).toUpperCase().indexOf(a.inputLabel.labelFilter.toUpperCase())&&-1<c.searchProperty.indexOf(e)){f=!0;
break}}else for(e in a.inputModel[b])if("boolean"!==typeof a.inputModel[b][e]&&0<=String(a.inputModel[b][e]).toUpperCase().indexOf(a.inputLabel.labelFilter.toUpperCase())){f=!0;break}!0===f&&a.filteredModel.push(a.inputModel[b])}"undefined"!==typeof a.inputModel[b][c.groupProperty]&&!0===a.inputModel[b][c.groupProperty]&&("undefined"!==typeof a.filteredModel[a.filteredModel.length-1][c.groupProperty]&&!1===a.filteredModel[a.filteredModel.length-1][c.groupProperty]?a.filteredModel.pop():a.filteredModel.push(a.inputModel[b]))}a.filteredModel.reverse();
v(function(){a.getFormElements();if(a.inputLabel.labelFilter.length>x){var b=[];angular.forEach(a.filteredModel,function(f,e){if("undefined"!==typeof f&&"undefined"===typeof f[c.groupProperty]){var g=angular.copy(f),g=b.push(g);delete b[g-1][a.indexProperty];delete b[g-1][a.spacingProperty]}});a.onSearchChange({data:{keyword:a.inputLabel.labelFilter,result:b}})}},0)};a.getFormElements=function(){g=[];var b=[],c=[],e=[],m=[];a.helperStatus.all||a.helperStatus.none||a.helperStatus.reset?(b=k.children().children().next().children().children()[0].getElementsByTagName("button"),
a.helperStatus.filter&&(c=k.children().children().next().children().children().next()[0].getElementsByTagName("input"),m=k.children().children().next().children().children().next()[0].getElementsByTagName("button"))):a.helperStatus.filter&&(c=k.children().children().next().children().children()[0].getElementsByTagName("input"),m=k.children().children().next().children().children()[0].getElementsByTagName("button"));for(var e=a.helperStatus.all||a.helperStatus.none||a.helperStatus.reset||a.helperStatus.filter?
k.children().children().next().children().next()[0].getElementsByTagName("input"):k.children().children().next()[0].getElementsByTagName("input"),d=0;d<b.length;d++)g.push(b[d]);for(d=0;d<c.length;d++)g.push(c[d]);for(d=0;d<m.length;d++)g.push(m[d]);for(d=0;d<e.length;d++)g.push(e[d])};a.isGroupMarker=function(a,f){return"undefined"!==typeof a[c.groupProperty]&&a[c.groupProperty]===f?!0:!1};a.removeGroupEndMarker=function(a){return"undefined"!==typeof a[c.groupProperty]&&!1===a[c.groupProperty]?!1:
!0};a.syncItems=function(b,f,e){f.preventDefault();f.stopPropagation();if("undefined"!==typeof c.disableProperty&&!0===b[c.disableProperty]||"undefined"!==typeof c.isDisabled&&!0===a.isDisabled||"undefined"!==typeof b[c.groupProperty]&&!1===b[c.groupProperty])return!1;var m=a.filteredModel.indexOf(b);if("undefined"!==typeof b[c.groupProperty]&&!0===b[c.groupProperty]){if("undefined"!==typeof c.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase())return!1;var d,h,g=0,k=a.filteredModel.length-1,
l=[],n=0;for(d=m;d<a.filteredModel.length&&!(0===n&&d>m);d++)if("undefined"!==typeof a.filteredModel[d][c.groupProperty]&&!0===a.filteredModel[d][c.groupProperty])0===l.length&&(g=d+1),n+=1;else if("undefined"!==typeof a.filteredModel[d][c.groupProperty]&&!1===a.filteredModel[d][c.groupProperty]){if(--n,0<l.length&&0===n){var p=!0,k=d;for(h=0;h<l.length;h++)if("undefined"!==typeof l[h][a.tickProperty]&&!1===l[h][a.tickProperty]){p=!1;break}if(!0===p)for(h=g;h<=k;h++)"undefined"===typeof a.filteredModel[h][c.groupProperty]&&
("undefined"===typeof c.disableProperty?(a.filteredModel[h][a.tickProperty]=!1,p=a.filteredModel[h][a.indexProperty],a.inputModel[p][a.tickProperty]=!1):!0!==a.filteredModel[h][c.disableProperty]&&(a.filteredModel[h][a.tickProperty]=!1,p=a.filteredModel[h][a.indexProperty],a.inputModel[p][a.tickProperty]=!1));else for(h=g;h<=k;h++)"undefined"===typeof a.filteredModel[h][c.groupProperty]&&("undefined"===typeof c.disableProperty?(a.filteredModel[h][a.tickProperty]=!0,p=a.filteredModel[h][a.indexProperty],
a.inputModel[p][a.tickProperty]=!0):!0!==a.filteredModel[h][c.disableProperty]&&(a.filteredModel[h][a.tickProperty]=!0,p=a.filteredModel[h][a.indexProperty],a.inputModel[p][a.tickProperty]=!0))}}else l.push(a.filteredModel[d])}else{if("undefined"!==typeof c.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase()){for(d=0;d<a.filteredModel.length;d++)a.filteredModel[d][a.tickProperty]=!1;for(d=0;d<a.inputModel.length;d++)a.inputModel[d][a.tickProperty]=!1;a.filteredModel[m][a.tickProperty]=!0}else a.filteredModel[m][a.tickProperty]=
!a.filteredModel[m][a.tickProperty];p=a.filteredModel[m][a.indexProperty];a.inputModel[p][a.tickProperty]=a.filteredModel[m][a.tickProperty]}t=angular.copy(b);null!==t&&v(function(){delete t[a.indexProperty];delete t[a.spacingProperty];a.onItemClick({data:t});t=null},0);a.refreshOutputModel();a.refreshButton();q=a.tabIndex;a.tabIndex=e+r;f.target.focus();a.removeFocusStyle(q);a.setFocusStyle(a.tabIndex);"undefined"!==typeof c.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase()&&a.toggleCheckboxes(f)};
a.refreshOutputModel=function(){a.outputModel=[];var b=[],f={};"undefined"!==typeof c.outputProperties?(b=c.outputProperties.split(" "),angular.forEach(a.inputModel,function(e,m){if("undefined"!==typeof e&&"undefined"===typeof e[c.groupProperty]&&!0===e[a.tickProperty]){f={};angular.forEach(e,function(a,c){-1<b.indexOf(c)&&(f[c]=a)});var d=a.outputModel.push(f);delete a.outputModel[d-1][a.indexProperty];delete a.outputModel[d-1][a.spacingProperty]}})):angular.forEach(a.inputModel,function(b,f){if("undefined"!==
typeof b&&"undefined"===typeof b[c.groupProperty]&&!0===b[a.tickProperty]){var d=angular.copy(b),d=a.outputModel.push(d);delete a.outputModel[d-1][a.indexProperty];delete a.outputModel[d-1][a.spacingProperty]}})};a.refreshButton=function(){a.varButtonLabel="";var b=0;if(0===a.outputModel.length)a.varButtonLabel=a.lang.nothingSelected;else{var f=a.outputModel.length;"undefined"!==typeof c.maxLabels&&""!==c.maxLabels&&(f=c.maxLabels);a.more=a.outputModel.length>f?!0:!1;angular.forEach(a.inputModel,
function(e,m){"undefined"!==typeof e&&!0===e[c.tickProperty]&&(b<f&&(a.varButtonLabel+=(0<a.varButtonLabel.length?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+a.writeLabel(e,"buttonLabel")),b++)});!0===a.more&&(0<f&&(a.varButtonLabel+=", ... "),a.varButtonLabel+="("+a.outputModel.length+")")}a.varButtonLabel=l.trustAsHtml(a.varButtonLabel+'<span class="caret"></span>')};a.itemIsDisabled=function(b){return"undefined"!==typeof c.disableProperty&&!0===b[c.disableProperty]?!0:!0===
a.isDisabled?!0:!1};a.writeLabel=function(a,f){var e=c[f].split(" "),m="";angular.forEach(e,function(c,f){a[c]&&(m+="&nbsp;"+c.split(".").reduce(function(a,b){return a[b]},a))});return"BUTTONLABEL"===f.toUpperCase()?m:l.trustAsHtml(m)};a.toggleCheckboxes=function(b){b=k.children()[0];angular.element(document).off("click",a.externalClickListener);angular.element(document).off("keydown",a.keyboardListener);if(angular.element(n).hasClass("show"))angular.element(n).removeClass("show"),angular.element(b).removeClass("buttonClicked"),
angular.element(document).off("click",a.externalClickListener),angular.element(document).off("keydown",a.keyboardListener),a.removeFocusStyle(a.tabIndex),"undefined"!==typeof g[a.tabIndex]&&g[a.tabIndex].blur(),v(function(){a.onClose()},0),k.children().children()[0].focus();else{a.inputLabel.labelFilter="";a.updateFilter();u=[];r=0;angular.element(n).addClass("show");angular.element(b).addClass("buttonClicked");angular.element(document).on("click",a.externalClickListener);angular.element(document).on("keydown",
a.keyboardListener);a.getFormElements();a.tabIndex=0;b=angular.element(k[0].querySelector(".helperContainer"))[0];if("undefined"!==typeof b){for(var c=0;c<b.getElementsByTagName("BUTTON").length;c++)u[c]=b.getElementsByTagName("BUTTON")[c];r=u.length+b.getElementsByTagName("INPUT").length}k[0].querySelector(".inputFilter")?(k[0].querySelector(".inputFilter").focus(),a.tabIndex=a.tabIndex+r-2,angular.element(k).children()[0].blur()):a.isDisabled||(a.tabIndex+=r,0<a.inputModel.length&&(g[a.tabIndex].focus(),
a.setFocusStyle(a.tabIndex),angular.element(k).children()[0].blur()));a.onOpen()}};a.externalClickListener=function(b){for(var c=k.find(b.target.tagName),e=0;e<c.length;e++)if(b.target==c[e])return;angular.element(n.previousSibling).removeClass("buttonClicked");angular.element(n).removeClass("show");angular.element(document).off("click",a.externalClickListener);angular.element(document).off("keydown",a.keyboardListener);v(function(){a.onClose()},0);k.children().children()[0].focus()};a.select=function(b,
f){var e=u.indexOf(f.target);a.tabIndex=e;switch(b.toUpperCase()){case "ALL":angular.forEach(a.filteredModel,function(b,f){"undefined"!==typeof b&&!0!==b[c.disableProperty]&&"undefined"===typeof b[c.groupProperty]&&(b[a.tickProperty]=!0)});a.refreshOutputModel();a.refreshButton();a.onSelectAll();break;case "NONE":angular.forEach(a.filteredModel,function(b,f){"undefined"!==typeof b&&!0!==b[c.disableProperty]&&"undefined"===typeof b[c.groupProperty]&&(b[a.tickProperty]=!1)});a.refreshOutputModel();
a.refreshButton();a.onSelectNone();break;case "RESET":angular.forEach(a.filteredModel,function(b,f){"undefined"===typeof b[c.groupProperty]&&"undefined"!==typeof b&&!0!==b[c.disableProperty]&&(b[a.tickProperty]=a.backUp[b[a.indexProperty]][a.tickProperty])});a.refreshOutputModel();a.refreshButton();a.onReset();break;case "CLEAR":a.tabIndex+=1;a.onClear();break;case "FILTER":a.tabIndex=u.length-1}};a.prepareGrouping=function(){var b=0;angular.forEach(a.filteredModel,function(f,e){f[a.spacingProperty]=
b;!0===f[c.groupProperty]?b+=2:!1===f[c.groupProperty]&&(b-=2)})};a.prepareIndex=function(){var b=0;angular.forEach(a.filteredModel,function(c,e){c[a.indexProperty]=b;b++})};a.keyboardListener=function(b){var c=b.keyCode?b.keyCode:b.which,e=!1;if(27===c)b.preventDefault(),b.stopPropagation(),a.toggleCheckboxes(b);else if(40===c||39===c||!b.shiftKey&&9==c)for(e=!0,q=a.tabIndex,a.tabIndex++,a.tabIndex>g.length-1&&(a.tabIndex=0,q=g.length-1);!0===g[a.tabIndex].disabled&&(a.tabIndex++,a.tabIndex>g.length-
1&&(a.tabIndex=0),a.tabIndex!==q););else if(38===c||37===c||b.shiftKey&&9==c)for(e=!0,q=a.tabIndex,a.tabIndex--,0>a.tabIndex&&(a.tabIndex=g.length-1,q=0);!0===g[a.tabIndex].disabled;){a.tabIndex--;if(a.tabIndex===q)break;0>a.tabIndex&&(a.tabIndex=g.length-1)}!0===e&&(b.preventDefault(),g[a.tabIndex].focus(),"CHECKBOX"===document.activeElement.type.toUpperCase()?(a.setFocusStyle(a.tabIndex),a.removeFocusStyle(q)):(a.removeFocusStyle(q),a.removeFocusStyle(r),a.removeFocusStyle(g.length-1)))};a.setFocusStyle=
function(a){angular.element(g[a]).parent().parent().parent().addClass("multiSelectFocus")};a.removeFocusStyle=function(a){angular.element(g[a]).parent().parent().parent().removeClass("multiSelectFocus")};a.groupProperty=c.groupProperty;a.tickProperty=c.tickProperty;a.directiveId=c.directiveId;var w=function(a){for(var c="",e=0;e<a;e++)c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".charAt(Math.floor(52*Math.random()));return c}(5);a.indexProperty="idx_"+w;a.spacingProperty="spc_"+w;"undefined"!==
typeof c.orientation&&("HORIZONTAL"===c.orientation.toUpperCase()?(a.orientationH=!0,a.orientationV=!1):(a.orientationH=!1,a.orientationV=!0));n=k.children().children().next()[0];"undefined"!==typeof c.maxHeight&&(w=k.children().children().children()[0],angular.element(w).attr("style","height:"+c.maxHeight+"; overflow-y:scroll;"));for(var y in a.helperStatus)a.helperStatus.hasOwnProperty(y)&&"undefined"!==typeof c.helperElements&&-1===c.helperElements.toUpperCase().indexOf(y.toUpperCase())&&(a.helperStatus[y]=
!1);"undefined"!==typeof c.selectionMode&&"SINGLE"===c.selectionMode.toUpperCase()&&(a.helperStatus.all=!1,a.helperStatus.none=!1);a.icon={};a.icon.selectAll="&#10003;";a.icon.selectNone="&times;";a.icon.reset="&#8630;";a.icon.tickMark="&#10003;";"undefined"!==typeof c.translation?(a.lang.selectAll=l.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;"+a.translation.selectAll),a.lang.selectNone=l.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;"+a.translation.selectNone),a.lang.reset=l.trustAsHtml(a.icon.reset+
"&nbsp;&nbsp;"+a.translation.reset),a.lang.search=a.translation.search,a.lang.nothingSelected=l.trustAsHtml(a.translation.nothingSelected)):(a.lang.selectAll=l.trustAsHtml(a.icon.selectAll+"&nbsp;&nbsp;Select All"),a.lang.selectNone=l.trustAsHtml(a.icon.selectNone+"&nbsp;&nbsp;Select None"),a.lang.reset=l.trustAsHtml(a.icon.reset+"&nbsp;&nbsp;Reset"),a.lang.search="Search...",a.lang.nothingSelected="None Selected");a.icon.tickMark=l.trustAsHtml(a.icon.tickMark);"undefined"!==typeof c.MinSearchLength&&
0<parseInt(c.MinSearchLength)&&(x=Math.floor(parseInt(c.MinSearchLength)));a.$watch("inputModel",function(b){b&&(a.refreshOutputModel(),a.refreshButton())},!0);a.$watch("inputModel",function(b){b&&(a.backUp=angular.copy(a.inputModel),a.updateFilter(),a.prepareGrouping(),a.prepareIndex(),a.refreshOutputModel(),a.refreshButton())});a.$watch("isDisabled",function(b){a.isDisabled=b});var z=function(b){a.$apply(function(){a.scrolled=!1})};angular.element(document).bind("touchstart",z);var A=function(b){a.$apply(function(){a.scrolled=
!0})};angular.element(document).bind("touchmove",A);a.$on("$destroy",function(){angular.element(document).unbind("touchstart",z);angular.element(document).unbind("touchmove",A)})}}}]).run(["$templateCache",function(l){l.put("isteven-multi-select.htm",'<span class="multiSelect inlineBlock"><button id="{{directiveId}}" type="button"ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"ng-bind-html="varButtonLabel"ng-disabled="disable-button"></button><div class="checkboxLayer"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.all"ng-click="select( \'all\', $event );"ng-bind-html="lang.selectAll"></button><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.none"ng-click="select( \'none\', $event );"ng-bind-html="lang.selectNone"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled"ng-if="helperStatus.reset"ng-click="select( \'reset\', $event );"ng-bind-html="lang.reset"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{lang.search}}" type="text"ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="searchChanged()" class="inputFilter"/><button type="button" class="clearButton" ng-click="clearClicked( $event )" >\u00d7</button> </div> </div> <div class="checkBoxContainer"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );" ng-mouseleave="removeFocusStyle( tabIndex );"> <div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index"></div>  <div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div><span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true" ng-bind-html="icon.tickMark"></span></div></div></div></span>')}]);